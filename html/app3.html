
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width">

<link rel="stylesheet" href="tz.css">
<link rel="stylesheet" href="app.css">

<script src="https:////ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/json2html/2.1.0/json2html.min.js"></script>
</head>


<body class="bg-default-900">
<div class="flex justify-between h-14 px-3 items-center">
<div>
</div>
 <div>
<form autocomplete="off">
<div class="w-full">
<label for="search-input" class="sr-only">
Search</label>
 <div class="relative w-full">
<div class="flex absolute inset-y-0 left-0 items-center pl-2 pointer-events-none">
<svg class="w-4 h-4 text-muted-100" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
<path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd">
</path>
</svg>
</div>
 <input type="search" id="search-input" class="bg-default-500 text-white outline-none rounded block w-[232px] h-8 pl-8 pr-4 py-1" placeholder="Search channel">
</div>
</div>
</form>
</div>
</div>
 <div class="w-full overflow-x-scroll relative h-[calc(100vh-60px)] pb-4">
<div class="space-y-1 flex flex-col relative">
<div class="table">
<div class="flex flex-col">
<div class="flex sticky top-0 bg-default-900 z-30">
<div class="sticky left-0 bg-default-900 z-10 w-[200px] h-[40px]">
<div class="relative" style="width: 100%; height: 40px;">
<button class="px-3 py-2 rounded border-0 text-muted-50 outline-none flex items-center text-left justify-between" style="width: 100%; height: 40px;">
<div class="leading-4">
Yesterday<br>
Oct 17, 2023</div>
 <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
<path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5">
</path>
</svg>
</button>
 </div>
</div>
 <div id="timeline" >
 </div>
</div>
 
 <div class="mask">
  <div id="message2" class="message"></div>
</div>

 <div id="serviceslist" />
<script>

	function roundToNearest30(date = new Date()) {
		const minutes = 30;
		const ms = 1000 * 60 * minutes;

		// üëáÔ∏è replace Math.round with Math.ceil to always round UP
		return new Date(Math.round(date.getTime() / ms) * ms);
	}

    var currentTime = roundToNearest30().getTime();
		
	function timelinePosition() {
		var timeDiff = ((new Date().getTime()) - (currentTime)) / 1000 / 60 * 6;
		return 2360+timeDiff;
		//return 400;
	}
	
	function openPlayer(url) {
		var wrapper = document.getElementById("message2");
		var url = 'videoplayer.html?video='+url
		wrapper.innerHTML = '<iframe width="560" height="315" src="'+url+'" frameborder="0" allowfullscreen></iframe>'
		$(".mask").show();
		//var win = window.open();
		//win.document.write('<iframe width="560" height="315" src="'+url+'" frameborder="0" allowfullscreen></iframe>');
	}
	
	var sixHoursAgo = new Date(currentTime - (6*60*60*1000));
	var thirtyTwoHoursAhead = new Date(currentTime + (32*60*60*1000));
	var thirtyMins = (30*60*1000);
	console.log(currentTime);
	console.log(sixHoursAgo);
	console.log(thirtyTwoHoursAhead);
	var timeline = '<div class="flex">';
	for (let i = sixHoursAgo.getTime(); i < thirtyTwoHoursAhead.getTime(); i += thirtyMins) {
		var d = new Date(i);
		timeline += '<div class="text-muted-50 w-[180px] relative h-10 shrink-0">'
		timeline += '<div class="absolute -left-0 top-0">'+d.getHours()+':'+ (d.getMinutes() == 0 ? '00' : '30') +'</div><div class="absolute bottom-0 border-l border-l-muted-200 h-4"></div></div>'
	}
	timeline += '</div>'
	var wrapper = document.getElementById("timeline");
	wrapper.innerHTML = timeline
	
    $(async function onLoad(){
        
		const response = await fetch('backend.json?action=get_services');
		const data = await response.json(); 
		//console.log(data);

		let epg = [];
		for (let i = 0; i < data.length; i++) {
			if(data[i]['channel_id'] == "") continue;
			const response = await fetch('backend.json?action=get_epg&channel_id='+data[i]['channel_id']);
			const data2 = await response.json(); 
			data[i]["epg"] = data2
		}
		console.log(data);
		
		json2html.component.add({
		
			"service/info":{'<>':'div','class':'sticky left-0 pr-[1px] z-20 bg-default-900 border-b-[4px] border-default-900','html':[
                {'<>':'div','class':'bg-default-800 rounded-sm text-white w-[200px] shrink-0 flex space-x-3 items-center px-3 py-2 h-[80px]','html':[
					{'<>':'div','class':'w-[48px] h-[25px] flex justify-center items-center shrink-0','html':[
						{'<>':'img','src':'${logo}','class':'max-w-[60px] max-h-[60px]','loading':'lazy','referrerpolicy':'no-referrer','alt':'${channel_name}'}
					]},
					{'<>':'div','html':[
						{'<>':'a','href':'javascript:openPlayer\("${url}"\)','html':'${channel_name}'}
					]}
				]}
            ]},
			"service/epg":{"[]":"service/singleepg","{}":o=>o.epg},
			
			"service/singleepg":{'<>':'div','class':'flex relative w-full border-b-[4px] border-default-900','html':[

				{'<>':'div','class':'px-[2px] shrink-0 absolute h-[52px] cursor-default" style="max-width: 780px; width: 780px; min-width: 780px; left: 300;','html':[
					{'<>':'div','class':'bg-default-700 rounded-sm py-2 overflow-hidden transition-colors duration-100 svelte-1o2ja8p','html':[
						{'<>':'div','class':'text-white whitespace-nowrap px-3','html':'Test123 ${title}'},
						{'<>':'div','class':'text-muted-200 whitespace-nowrap px-3','html':'Hello123 ${start}'}
					]}
				]}
			]}
		});
		
		let template = {'service':{'<>':'div','class':'flex','html':[
            {"[]":"service/info"},
			{"[]":"service/epg"}
		]}};
		

        $('#serviceslist').json2html(data,template.service);
		
    });
    				//{'<>':'div','class':'rounded-sm bg-default-700 w-[calc(100vw-204px)] h-[80px] sticky left-[204px] flex items-center text-white px-3','html':'Loading...'}
				
</script>
</div>
</div>
<div id="timelinebar">
 <div class="absolute top-[36px] bottom-0 w-[1px] bg-accent z-10" style="left: 2360px;">
</div>
</div>
<div onload="onLoad()" />
</div>
</div>
 <script>
		function updateTimelinebar() {
			var wrapper = document.getElementById("timelinebar");
			wrapper.innerHTML = '<div class="absolute top-[36px] bottom-0 w-[1px] bg-accent z-10" style="left: '+timelinePosition()+'px;" ></div>'
		}
		updateTimelinebar();
		setInterval(function() {
			updateTimelinebar();
		}, 60 * 1000);
</script>
</body>
</html>
